---
## Front matter
title: "Отчёт по лабораторной работе №9"
subtitle: "Управление SELinux"
author: "Щемелев Илья Владимирович"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true
toc-depth: 2
lof: true
lot: true
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
    - spelling=modern
    - babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float}
  - \floatplacement{figure}{H}
---

# Цель работы

Получить навыки работы с контекстом безопасности и политиками SELinux.

# Ход выполнения

## Управление режимами SELinux

1. Запущен терминал и получены полномочия администратора с помощью команды `su -`.  
   Это позволило выполнять действия, требующие прав суперпользователя, и управлять настройками безопасности системы.

2. Для получения подробной информации о текущем состоянии SELinux выполнена команда `sestatus -v`.  
   В результате на экран выведены следующие сведения (пояснение построчно):

   - **SELinux status: enabled** — SELinux включён и функционирует.
   - **SELinuxfs mount: /sys/fs/selinux** — служебная файловая система SELinux смонтирована по указанному пути.
   - **SELinux root directory: /etc/selinux** — каталог, содержащий конфигурацию SELinux.
   - **Loaded policy name: targeted** — загружена политика типа *targeted* (защищаются ключевые службы/процессы).
   - **Current mode: enforcing** — активен принудительный режим применения политики (нарушения блокируются).
   - **Mode from config file: enforcing** — в конфигурации также установлен режим enforcing.
   - **Policy MLS status: enabled** — поддержка MLS (многоуровневая защита) активна.
   - **Policy deny_unknown status: allowed** — неизвестные действия не запрещаются автоматически (разрешены).
   - **Memory protection checking: actual (secure)** — включена проверка механизмов защиты памяти.
   - **Max kernel policy version: 33** — максимальная версия политики, поддерживаемая ядром.

   Далее выводится раздел контекстов:

   - **Process contexts** — контексты безопасности для процессов.
     - **Current context: unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023** — текущий пользовательский сеанс выполняется в домене *unconfined_t* (ограничения SELinux минимальны).
     - **Init context: system_u:system_r:init_t:s0** — контекст процесса инициализации.
     - **/usr/sbin/sshd: system_u:system_r:sshd_t:s0-s0:c0.c1023** — SSH-сервер работает в домене *sshd_t* (типичный защищаемый домен targeted-политики).

   - **File contexts** — контексты безопасности для файлов/объектов.
     - **Controlling terminal: unconfined_u:object_r:user_devpts_t:s0** — контекст псевдотерминала пользователя.
     - **/etc/passwd: system_u:object_r:passwd_file_t:s0** — файл паролей имеет тип *passwd_file_t*.
     - **/etc/shadow: system_u:object_r:shadow_t:s0** — файл хэшей паролей имеет тип *shadow_t*.
     - **/bin/bash: system_u:object_r:shell_exec_t:s0** — исполняемый файл оболочки имеет тип *shell_exec_t*.
     - **/bin/login: system_u:object_r:login_exec_t:s0** — исполняемый файл login имеет тип *login_exec_t*.
     - **/bin/sh → system_u:object_r:shell_exec_t:s0** — для sh указан тип исполняемого файла оболочки.
     - **/sbin/agetty: system_u:object_r:getty_exec_t:s0** — agetty имеет тип *getty_exec_t*.
     - **/sbin/init → system_u:object_r:init_exec_t:s0** — init имеет тип *init_exec_t*.
     - **/usr/sbin/sshd: system_u:object_r:sshd_exec_t:s0** — бинарный файл sshd имеет тип *sshd_exec_t*.

   ![Проверка состояния SELinux](Screenshot_1.png)

3. Для определения режима работы SELinux выполнена команда `getenforce`.  
   В ответ получено значение **Enforcingал** (Enforcing), что означает принудительное применение политики.

4. Выполнено переключение SELinux в разрешающий режим командой `setenforce 0`.  
   После этого повторно введена команда `getenforce`, получено значение **Permissive**.  
   В режиме permissive нарушения не блокируются, а только фиксируются в журналах.

5. Для полного отключения SELinux выполнено редактирование файла `/etc/sysconfig/selinux` в редакторе nano.  
   Установлено значение параметра:

   - `SELINUX=disabled`

   После сохранения изменений выполнена перезагрузка системы.

   ![Отключение SELinux в конфигурации](Screenshot_2.png)

6. После перезагрузки снова запущен терминал и получены права администратора.

7. Выполнена проверка статуса командой `getenforce`.  
   Получено значение **Disabled**, что означает, что SELinux полностью отключён.

8. Выполнена попытка переключить режим SELinux командой `setenforce 1`.  
   Система вывела сообщение об ошибке, указывающее, что SELinux отключён.  
   Это подтверждает невозможность переключения режимов при отключённом SELinux без перезагрузки системы.

   ![Попытка включения SELinux без перезагрузки](Screenshot_3.png)

9. Файл `/etc/sysconfig/selinux` снова открыт и параметр изменён на:

   - `SELINUX=enforcing`

   После сохранения изменений выполнена перезагрузка.

   ![Возврат режима Enforcing](Screenshot_4.png)

10. Во время загрузки появилось предупреждение о необходимости восстановления меток SELinux.  
    Система запустила перемаркировку файловой системы (relabelling), что может занимать продолжительное время и сопровождаться дополнительной перезагрузкой.

11. После загрузки системы снова выполнена команда `sestatus -v`.  
    Полученная информация подтвердила, что SELinux включён и работает в режиме **enforcing**.

    ![Проверка SELinux после перемаркировки](Screenshot_5.png)

## Использование restorecon для восстановления контекста безопасности

1. Запущен терминал и получены полномочия администратора.

2. Просмотрен контекст безопасности файла `/etc/hosts` с помощью команды `ls -Z /etc/hosts`.  
   В результате установлено, что файл имеет контекст типа **net_conf_t**, соответствующий сетевым конфигурационным файлам.

   ![Контекст файла /etc/hosts](Screenshot_6.png)

3. Файл `/etc/hosts` скопирован в домашний каталог командой `cp /etc/hosts ~/`.  
   После копирования проверен контекст файла `~/hosts` командой `ls -Z ~/hosts`.  
   Контекст изменился на **admin_home_t**, так как копирование в домашний каталог создаёт новый файл с типичным домашним контекстом.

4. Выполнена попытка заменить существующий файл `/etc/hosts` перемещением файла из домашнего каталога: `mv ~/hosts /etc`.  
   Операция подтверждена пользователем.

5. Проверено, что после перемещения файл `/etc/hosts` сохранил неверный контекст **admin_home_t**, что подтверждено выводом команды `ls -Z /etc/hosts`.

6. Для восстановления корректного контекста выполнена команда `restorecon -v /etc/hosts`.  
   Опция `-v` вывела информацию о процессе исправления контекста.

7. Повторно проверен контекст командой `ls -Z /etc/hosts`.  
   Установлено, что тип контекста изменился на корректный **net_conf_t**.

8. Для массового исправления контекстов безопасности на файловой системе создан файл `/.autorelabel` командой `touch /.autorelabel`, после чего выполнена перезагрузка системы.  
   Во время загрузки были отображены сообщения о выполнении автоматической перемаркировки файловой системы.

   ![Сообщения перемаркировки во время загрузки](Screenshot_7.png)

## Настройка контекста безопасности для нестандартного расположения файлов веб-сервера

1. Запущен терминал и получены полномочия администратора, что позволило выполнять установку программного обеспечения и изменять системные конфигурационные файлы.

2. Установлено необходимое программное обеспечение для работы веб-сервера и проверки его функционирования:
   - веб-сервер Apache HTTP Server (httpd);
   - текстовый веб-браузер lynx.

3. Создан новый каталог `/web`, который будет использоваться в качестве хранилища файлов веб-сервера.  
   Данный каталог выбран намеренно, чтобы продемонстрировать работу SELinux с нестандартным расположением веб-контента.

4. В каталоге `/web` создан файл `index.html`.  
   В файл помещён текст:
   - **Welcome to my web-server**  
   Этот файл используется в качестве тестовой веб-страницы.

5. Выполнено редактирование конфигурационного файла веб-сервера `/etc/httpd/conf/httpd.conf`.  
   В ходе настройки:
   - строка `DocumentRoot "/var/www/html"` закомментирована;
   - добавлена новая строка `DocumentRoot "/web"`, указывающая на нестандартный каталог с веб-контентом;
   - закомментирован стандартный блок `<Directory "/var/www"> … </Directory>`;
   - добавлен новый блок:
     - `<Directory "/web">`
     - `AllowOverride None`
     - `Require all granted`
     - `</Directory>`
   
   Данные изменения определяют правила доступа и разрешают веб-серверу обслуживать содержимое каталога `/web`.

   ![Изменение конфигурации httpd](Screenshot_8.png)

6. Веб-сервер запущен и добавлен в автозагрузку службы systemd.  
   При первоначальном обращении к веб-серверу отображается стандартная тестовая страница Rocky Linux, что указывает на то, что SELinux блокирует доступ к файлам в каталоге `/web` из-за некорректного контекста безопасности.

   ![Тестовая страница Apache по умолчанию](Screenshot_9.png)

7. Под пользовательской учётной записью выполнено обращение к веб-серверу с помощью текстового браузера lynx по адресу `http://localhost`.  
   Вместо пользовательской страницы отображена стандартная тестовая страница, что подтверждает ограничение доступа со стороны SELinux.

8. Для разрешения доступа веб-сервера к каталогу `/web` добавлено новое правило контекста безопасности SELinux.  
   Для каталога `/web` и всех вложенных файлов установлен тип контекста **httpd_sys_content_t**, предназначенный для веб-контента Apache.

9. Выполнено восстановление контекста безопасности каталога `/web` и всех файлов внутри него.  
   В процессе восстановления отображены сообщения о смене контекста для каталога `/web` и файла `index.html`.

   ![Применение контекста безопасности к каталогу /web](Screenshot_10.png)

10. Повторно выполнено обращение к веб-серверу с помощью браузера lynx.  
    В результате успешно отображена пользовательская веб-страница с текстом **Welcome to my web-server**, что подтверждает корректную настройку SELinux для нестандартного расположения веб-контента.

    ![Отображение пользовательской веб-страницы](Screenshot_11.png)

## Работа с переключателями SELinux

1. Запущен терминал и получены полномочия администратора.

2. Просмотрен список переключателей SELinux, относящихся к службе FTP.  
   В списке обнаружен переключатель **ftpd_anon_write**, имеющий текущее значение **off**, что означает запрет анонимной записи для FTP-службы.

   ![Список FTP-переключателей SELinux](Screenshot_12.png)

3. Получен расширенный список переключателей для службы `ftpd_anon` с пояснениями.  
   Установлено, что:
   - переключатель **ftpd_anon_write** разрешает или запрещает анонимную запись через FTP;
   - временное и постоянное значения переключателя различаются.

4. Текущее (временное) значение переключателя **ftpd_anon_write** изменено с **off** на **on**.  
   Это разрешило анонимную запись для FTP-службы до следующей перезагрузки системы.

5. Повторная проверка состояния переключателя показала, что **ftpd_anon_write** находится в состоянии **on** для текущего сеанса.

6. Повторно просмотрен список переключателей с пояснениями.  
   Установлено, что:
   - временное значение переключателя включено;
   - постоянное значение по-прежнему остаётся выключенным.

7. Выполнено включение постоянного значения переключателя **ftpd_anon_write**.  
   Данное изменение сохраняется после перезагрузки системы.

8. После повторного просмотра списка переключателей установлено, что:
   - временное значение переключателя **ftpd_anon_write** — **on**;
   - постоянное значение переключателя **ftpd_anon_write** — **on**.

# Контрольные вопросы

1. Для временного перевода SELinux в разрешающий режим используется команда:

   - **setenforce 0** — переводит SELinux в режим *Permissive*, при котором нарушения политики не блокируются, а только регистрируются в журналах.
   
   Проверить текущий режим можно с помощью команды **getenforce**.

2. Для получения списка всех доступных переключателей SELinux применяется команда:

   - **getsebool -a** — выводит полный список всех SELinux boolean-переключателей и их текущие значения (on/off).

3. Для получения легко читаемых сообщений SELinux в журнале аудита необходимо установить пакет:

   - **setroubleshoot-server** — данный пакет анализирует события SELinux и формирует понятные диагностические сообщения, упрощающие поиск и устранение проблем.

4. Для применения типа контекста **httpd_sys_content_t** к каталогу `/web` необходимо выполнить следующие действия:

   - добавить правило для нового контекста безопасности, указывающее, что каталог `/web` и все вложенные файлы относятся к веб-контенту;
   - восстановить контексты безопасности для каталога `/web`.

   Эти действия обеспечивают корректный доступ веб-сервера Apache к файлам, расположенным вне стандартного каталога `/var/www`.

5. Для полного отключения SELinux необходимо изменить конфигурационный файл:

   - **/etc/sysconfig/selinux**

   В данном файле параметру `SELINUX` должно быть присвоено значение `disabled`.  
   Изменения вступают в силу только после перезагрузки системы.

6. SELinux регистрирует все свои сообщения в журнале аудита:

   - **/var/log/audit/audit.log**

   Именно в этом файле содержится подробная информация обо всех разрешённых и запрещённых действиях, связанных с политиками SELinux.

7. Для получения подробной информации о доступных типах контекстов и переключателях, относящихся к службе FTP, используется команда:

   - **semanage boolean -l | grep ftp**

   Она выводит список boolean-переключателей SELinux для FTP-службы с пояснением их назначения и текущего состояния.

8. Если сервис работает некорректно и требуется определить, связано ли это с SELinux, самым простым способом является:

   - временный перевод SELinux в режим *Permissive*.

   Если после этого сервис начинает работать корректно, значит проблема связана с политиками SELinux.  
   Дополнительно для анализа причин можно изучить журнал аудита SELinux.

# Заключение

В ходе выполнения лабораторной работы были изучены принципы работы механизма SELinux, способы управления его режимами и средствами контроля доступа. Были освоены методы временного и постоянного изменения режима работы SELinux, а также процедуры восстановления контекстов безопасности. Практически продемонстрирована настройка SELinux для обеспечения корректной работы веб-сервера с нестандартным расположением файлов и использование переключателей безопасности (boolean). Полученные результаты подтверждают, что корректная настройка SELinux позволяет повысить уровень безопасности системы без нарушения работоспособности сервисов.
